<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JCT Estate Task Manager</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#333}
.container{max-width:1400px;margin:0 auto;background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden}
.header{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);color:white;padding:30px;text-align:center}
.header h1{font-size:32px;margin-bottom:10px}
.header p{font-size:18px;opacity:0.9}
.loading-overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:9999}
.loading-overlay.show{display:flex}
.loading-spinner{color:white;font-size:24px;text-align:center}
.tabs{display:flex;background:#f8f9fa;border-bottom:3px solid #dee2e6}
.tab{flex:1;padding:20px;text-align:center;font-size:20px;font-weight:bold;cursor:pointer;border:none;background:#f8f9fa;color:#6c757d;transition:all 0.3s;min-height:70px;display:flex;align-items:center;justify-content:center;gap:10px}
.tab:hover{background:#e9ecef}
.tab.active{background:white;color:#1e3c72;border-bottom:3px solid #1e3c72}
.tab i{font-size:24px}
.tab-content{display:none;padding:30px;animation:fadeIn 0.3s}
.tab-content.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
.stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.2);text-align:center}
.stat-card.completed{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%)}
.stat-card.progress{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
.stat-card.overdue{background:linear-gradient(135deg,#fa709a 0%,#fee140 100%)}
.stat-card i{font-size:48px;margin-bottom:15px}
.stat-number{font-size:48px;font-weight:bold;margin:10px 0}
.stat-label{font-size:20px;opacity:0.9}
.progress-section{background:#f8f9fa;padding:30px;border-radius:15px;margin-bottom:30px}
.progress-label{font-size:20px;font-weight:bold;margin-bottom:15px;color:#1e3c72}
.progress-bar-container{background:#dee2e6;height:40px;border-radius:20px;overflow:hidden;position:relative}
.progress-bar{height:100%;background:linear-gradient(90deg,#11998e 0%,#38ef7d 100%);transition:width 0.5s ease;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:18px}
.filters{display:flex;flex-wrap:wrap;gap:15px;margin-bottom:30px}
.filter-btn{padding:15px 30px;border:none;border-radius:10px;background:#e9ecef;color:#495057;font-size:18px;font-weight:bold;cursor:pointer;transition:all 0.3s;min-height:55px}
.filter-btn:hover{background:#dee2e6;transform:translateY(-2px)}
.filter-btn.active{background:#1e3c72;color:white}
.urgent-section{background:#fff3cd;border-left:5px solid #ffc107;padding:25px;border-radius:10px;margin-bottom:30px}
.urgent-section h3{color:#856404;margin-bottom:20px;font-size:24px}
.urgent-task{background:white;padding:20px;border-radius:10px;margin-bottom:15px;border-left:5px solid #dc3545}
.table-container{overflow-x:auto;background:#f8f9fa;border-radius:15px;padding:20px}
table{width:100%;border-collapse:collapse;background:white;border-radius:10px;overflow:hidden}
th{background:#1e3c72;color:white;padding:20px;text-align:left;font-size:18px;font-weight:bold}
td{padding:20px;border-bottom:1px solid #dee2e6;font-size:16px}
tr:hover{background:#f8f9fa}
.status-badge{padding:10px 20px;border-radius:20px;font-weight:bold;display:inline-block;font-size:14px;cursor:pointer;transition:all 0.3s;min-width:120px;text-align:center}
.status-badge:hover{transform:scale(1.05)}
.status-completed{background:#d4edda;color:#155724}
.status-progress{background:#fff3cd;color:#856404}
.status-notstarted{background:#f8d7da;color:#721c24}
.priority-badge{padding:8px 15px;border-radius:15px;font-weight:bold;display:inline-block;font-size:14px}
.priority-high{background:#dc3545;color:white}
.priority-medium{background:#ffc107;color:#333}
.priority-low{background:#28a745;color:white}
.btn{padding:15px 30px;border:none;border-radius:10px;font-size:18px;font-weight:bold;cursor:pointer;transition:all 0.3s;min-height:55px;display:inline-flex;align-items:center;justify-content:center;gap:10px}
.btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
.btn-primary{background:#1e3c72;color:white}
.btn-success{background:#28a745;color:white}
.btn-danger{background:#dc3545;color:white}
.btn-secondary{background:#6c757d;color:white}
.action-btns{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:30px}
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5)}
.modal.active{display:flex;align-items:center;justify-content:center}
.modal-content{background:white;padding:40px;border-radius:20px;max-width:600px;width:90%;max-height:90vh;overflow-y:auto}
.modal h2{margin-bottom:25px;color:#1e3c72;font-size:28px}
.form-group{margin-bottom:25px}
.form-group label{display:block;margin-bottom:10px;font-weight:bold;font-size:18px;color:#495057}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:15px;border:2px solid #dee2e6;border-radius:10px;font-size:16px}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#1e3c72}
.form-group textarea{min-height:100px;resize:vertical}
.days-badge{padding:5px 10px;border-radius:10px;font-weight:bold;font-size:14px;display:inline-block}
.days-overdue{background:#dc3545;color:white}
.days-soon{background:#ffc107;color:#333}
.days-ok{background:#28a745;color:white}
.success-message{background:#d4edda;color:#155724;padding:15px 20px;border-radius:10px;margin:20px 30px;display:none;border-left:5px solid #28a745}
.success-message.show{display:block}
.cloud-status{background:#e3f2fd;padding:15px;border-radius:10px;margin-bottom:20px;border-left:5px solid #2196f3;display:flex;align-items:center;gap:10px}
.cloud-status i{color:#2196f3;font-size:20px}
@media(max-width:768px){
.header h1{font-size:24px}
.tabs{flex-direction:column}
.stats-grid{grid-template-columns:1fr}
th,td{padding:10px}
}
</style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
<div class="loading-spinner">
<i class="fas fa-spinner fa-spin fa-3x"></i>
<div style="margin-top:20px">Loading tasks from cloud...</div>
</div>
</div>

<div class="container">
<div class="header">
<h1><i class="fas fa-tasks"></i> JCT Estate Task Manager</h1>
<p>Simple. Powerful. Always Working.</p>
<div style="margin-top:15px">
<span id="loginStatus" style="font-size:16px"><i class="fas fa-eye"></i> View Mode</span>
<button class="btn btn-secondary" id="adminLoginBtn" style="margin-left:15px;padding:10px 20px;min-height:auto"><i class="fas fa-key"></i> Admin Login</button>
<button class="btn btn-danger" id="logoutBtn" style="margin-left:10px;padding:10px 20px;min-height:auto;display:none"><i class="fas fa-sign-out-alt"></i> Logout</button>
</div>
</div>

<div class="cloud-status">
<i class="fas fa-cloud"></i>
<div>
<strong>Cloud Storage Active</strong> - All changes sync automatically across all devices and browsers
</div>
</div>

<div class="success-message" id="successMessage">
<i class="fas fa-check-circle"></i> <span id="successText">Saved!</span>
</div>

<div class="tabs">
<button class="tab active" data-tab="dashboard"><i class="fas fa-chart-line"></i> Dashboard</button>
<button class="tab" data-tab="tasks"><i class="fas fa-list-check"></i> Tasks</button>
</div>

<div class="tab-content active" id="dashboard">
<div class="stats-grid">
<div class="stat-card"><i class="fas fa-clipboard-list"></i><div class="stat-number" id="totalTasks">0</div><div class="stat-label">Total Tasks</div></div>
<div class="stat-card completed"><i class="fas fa-check-circle"></i><div class="stat-number" id="completedTasks">0</div><div class="stat-label">Completed</div></div>
<div class="stat-card progress"><i class="fas fa-spinner"></i><div class="stat-number" id="progressTasks">0</div><div class="stat-label">In Progress</div></div>
<div class="stat-card overdue"><i class="fas fa-exclamation-triangle"></i><div class="stat-number" id="overdueTasks">0</div><div class="stat-label">Overdue</div></div>
</div>

<div class="progress-section">
<div class="progress-label">Overall Completion Progress</div>
<div class="progress-bar-container"><div class="progress-bar" id="progressBar">0%</div></div>
</div>

<div class="filters" id="filters"></div>

<div class="urgent-section">
<h3><i class="fas fa-bell"></i> Urgent Tasks</h3>
<div id="urgentTasksList"></div>
</div>
</div>

<div class="tab-content" id="tasks">
<div class="action-btns" id="actionBtns">
<button class="btn btn-primary" id="addTaskBtn"><i class="fas fa-plus"></i> Add Task</button>
<button class="btn btn-success" id="exportBtn"><i class="fas fa-download"></i> Export</button>
<button class="btn btn-secondary" id="importBtn"><i class="fas fa-upload"></i> Import CSV</button>
<input type="file" id="importFile" accept=".csv" style="display:none">
</div>

<div class="table-container">
<table><thead><tr><th>ID</th><th>Description</th><th>Category</th><th>Responsible</th><th>Deadline</th><th>Days</th><th>Status</th><th>Priority</th><th>Last Updated</th><th>Actions</th></tr></thead>
<tbody id="taskTableBody"></tbody></table>
</div>
</div>
</div>

<div class="modal" id="addTaskModal">
<div class="modal-content">
<h2><i class="fas fa-plus-circle"></i> <span id="modalTitle">Add Task</span></h2>
<input type="hidden" id="editTaskId">
<div class="form-group"><label>Description *</label><textarea id="taskDesc" required></textarea></div>
<div class="form-group"><label>Category *</label><select id="taskCategory" required><option value="">Select</option><option>Arts & Science</option><option>Polytechnic</option><option>Engineering</option><option>Campus</option><option>Girls Hostel</option><option>Boys Hostel</option><option>Mess</option><option>Transport</option></select></div>
<div class="form-group"><label>Responsible *</label><input type="text" id="taskResponsible" required></div>
<div class="form-group"><label>Deadline</label><input type="date" id="taskDeadline"></div>
<div class="form-group"><label>Status *</label><select id="taskStatus" required><option>Not Started</option><option>In Progress</option><option>Completed</option></select></div>
<div class="form-group"><label>Priority *</label><select id="taskPriority" required><option>Low</option><option>Medium</option><option>High</option></select></div>
<div class="form-group"><label>Remarks</label><textarea id="taskRemarks"></textarea></div>
<div class="action-btns">
<button class="btn btn-primary" id="saveTaskBtn"><i class="fas fa-save"></i> Save</button>
<button class="btn btn-secondary" id="cancelTaskBtn"><i class="fas fa-times"></i> Cancel</button>
</div>
</div>
</div>

<div class="modal" id="loginModal">
<div class="modal-content">
<h2><i class="fas fa-lock"></i> Admin Login</h2>
<div class="form-group"><label>Password</label><input type="password" id="adminPassword" placeholder="Enter admin password"></div>
<div class="action-btns">
<button class="btn btn-primary" id="loginBtn"><i class="fas fa-sign-in-alt"></i> Login</button>
<button class="btn btn-secondary" id="cancelLoginBtn"><i class="fas fa-times"></i> Cancel</button>
</div>
</div>
</div>

<script>
const App = {
  tasks: [],
  currentFilter: 'all',
  isAdmin: false,
  ADMIN_PASSWORD: 'jct2025',
  STORAGE_KEY: 'jct-tasks-data',

  async init() {
    await this.loadTasksFromCloud();
    this.checkAdminStatus();
    this.setupEventListeners();
    this.renderFilters();
    this.renderDashboard();
    this.renderTaskTable();
  },

  setupEventListeners() {
    document.getElementById('adminLoginBtn').addEventListener('click', () => this.showLoginModal());
    document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
    document.getElementById('loginBtn').addEventListener('click', () => this.login());
    document.getElementById('cancelLoginBtn').addEventListener('click', () => this.closeLoginModal());
    document.getElementById('addTaskBtn').addEventListener('click', () => this.openAddTaskModal());
    document.getElementById('saveTaskBtn').addEventListener('click', () => this.saveTask());
    document.getElementById('cancelTaskBtn').addEventListener('click', () => this.closeAddTaskModal());
    document.getElementById('exportBtn').addEventListener('click', () => this.exportToCSV());
    document.getElementById('importBtn').addEventListener('click', () => document.getElementById('importFile').click());
    document.getElementById('importFile').addEventListener('change', (e) => this.importFromCSV(e));
    
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', (e) => this.switchTab(e.currentTarget.dataset.tab));
    });
  },

  renderFilters() {
    const categories = ['All', 'Arts & Science', 'Polytechnic', 'Engineering', 'Campus', 'Girls Hostel', 'Boys Hostel', 'Mess', 'Transport'];
    const icons = ['th', 'university', 'cog', 'wrench', 'building', 'female', 'male', 'utensils', 'bus'];
    
    const html = categories.map((cat, i) => 
      `<button class="filter-btn ${cat === 'All' ? 'active' : ''}" data-category="${cat === 'All' ? 'all' : cat}">
        <i class="fas fa-${icons[i]}"></i> ${cat}
      </button>`
    ).join('');
    
    document.getElementById('filters').innerHTML = html;
    
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        this.currentFilter = e.currentTarget.dataset.category;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        e.currentTarget.classList.add('active');
        this.renderDashboard();
      });
    });
  },

  async loadTasksFromCloud() {
    this.showLoading(true);
    try {
      // First check localStorage for any existing data
      const localData = localStorage.getItem('jctTasks');
      
      // Try to load from cloud
      const result = await window.storage.get(this.STORAGE_KEY, true);
      
      if (result && result.value) {
        // Cloud data exists, use it
        const data = JSON.parse(result.value);
        this.tasks = data.tasks || [];
        console.log('Loaded from cloud:', this.tasks.length, 'tasks');
        
        // Update localStorage as backup
        localStorage.setItem('jctTasks', JSON.stringify(this.tasks));
      } else if (localData) {
        // Cloud is empty but localStorage has data, use localStorage and sync to cloud
        console.log('Cloud empty, loading from localStorage');
        this.tasks = JSON.parse(localData);
        await this.saveTasksToCloud();
      } else {
        // Both empty, initialize with sample tasks
        console.log('No data found, creating sample tasks');
        this.tasks = this.getSampleTasks();
        await this.saveTasksToCloud();
      }
    } catch (error) {
      console.error('Cloud load error:', error);
      
      // Fallback to localStorage
      const localData = localStorage.getItem('jctTasks');
      if (localData) {
        this.tasks = JSON.parse(localData);
        console.log('Error loading cloud, using localStorage:', this.tasks.length, 'tasks');
      } else {
        this.tasks = this.getSampleTasks();
        console.log('Error loading cloud, using sample tasks');
      }
      
      // Try to save to cloud in background (don't show error to user)
      setTimeout(() => this.saveTasksToCloud(true), 2000);
    } finally {
      this.showLoading(false);
    }
  },

  async saveTasksToCloud(silent = false) {
    try {
      const data = { tasks: this.tasks, lastSync: new Date().toISOString() };
      await window.storage.set(this.STORAGE_KEY, JSON.stringify(data), true);
      
      // Always save to localStorage as backup
      localStorage.setItem('jctTasks', JSON.stringify(this.tasks));
      
      console.log('Saved to cloud:', this.tasks.length, 'tasks');
      if (!silent) {
        this.showSuccess('Saved to cloud');
      }
    } catch (error) {
      console.error('Cloud save error:', error);
      
      // Still save to localStorage
      localStorage.setItem('jctTasks', JSON.stringify(this.tasks));
      
      if (!silent) {
        this.showSuccess('Saved locally (cloud sync pending)');
      }
    }
  },

  showLoading(show) {
    document.getElementById('loadingOverlay').classList.toggle('show', show);
  },

  checkAdminStatus() {
    this.isAdmin = sessionStorage.getItem('jctAdminLoggedIn') === 'true';
    this.updateUIForRole();
  },

  updateUIForRole() {
    const status = document.getElementById('loginStatus');
    const logoutBtn = document.getElementById('logoutBtn');
    const actionBtns = document.getElementById('actionBtns');
    
    if (this.isAdmin) {
      status.innerHTML = '<i class="fas fa-user-shield"></i> Admin Mode';
      status.style.color = '#28a745';
      logoutBtn.style.display = 'inline-flex';
      actionBtns.style.display = 'flex';
    } else {
      status.innerHTML = '<i class="fas fa-eye"></i> View Mode';
      status.style.color = '#ffc107';
      logoutBtn.style.display = 'none';
      actionBtns.style.display = 'none';
    }
  },

  showLoginModal() {
    document.getElementById('loginModal').classList.add('active');
    document.getElementById('adminPassword').value = '';
  },

  closeLoginModal() {
    document.getElementById('loginModal').classList.remove('active');
  },

  login() {
    const pwd = document.getElementById('adminPassword').value;
    if (pwd === this.ADMIN_PASSWORD) {
      this.isAdmin = true;
      sessionStorage.setItem('jctAdminLoggedIn', 'true');
      this.updateUIForRole();
      this.closeLoginModal();
      this.showSuccess('Logged in as Admin!');
      this.renderTaskTable();
    } else {
      alert('Invalid password!');
    }
  },

  logout() {
    this.isAdmin = false;
    sessionStorage.removeItem('jctAdminLoggedIn');
    this.updateUIForRole();
    this.showSuccess('Logged out');
    this.renderTaskTable();
  },

  switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(tabName).classList.add('active');
  },

  renderDashboard() {
    const filtered = this.currentFilter === 'all' ? this.tasks : this.tasks.filter(t => t.category === this.currentFilter);
    const total = filtered.length;
    const completed = filtered.filter(t => t.status === 'Completed').length;
    const progress = filtered.filter(t => t.status === 'In Progress').length;
    const overdue = filtered.filter(t => this.isOverdue(t.deadline) && t.status !== 'Completed').length;
    
    document.getElementById('totalTasks').textContent = total;
    document.getElementById('completedTasks').textContent = completed;
    document.getElementById('progressTasks').textContent = progress;
    document.getElementById('overdueTasks').textContent = overdue;
    
    const pct = total > 0 ? Math.round((completed / total) * 100) : 0;
    document.getElementById('progressBar').style.width = pct + '%';
    document.getElementById('progressBar').textContent = pct + '%';
    
    const urgent = filtered.filter(t => t.priority === 'High' && t.status !== 'Completed');
    const html = urgent.length === 0 
      ? '<div class="urgent-task">No urgent tasks! Great job!</div>' 
      : urgent.map(t => `<div class="urgent-task"><strong>${t.description}</strong><br><small>${t.category} - ${t.responsible} - Due: ${t.deadline}</small></div>`).join('');
    document.getElementById('urgentTasksList').innerHTML = html;
  },

  renderTaskTable() {
    const html = this.tasks.map(t => `
      <tr>
        <td>${t.id}</td>
        <td>${t.description}</td>
        <td>${t.category}</td>
        <td>${t.responsible}</td>
        <td>${t.deadline}</td>
        <td>${this.getDaysBadge(t.deadline, t.status)}</td>
        <td><span class="status-badge status-${t.status.toLowerCase().replace(' ', '')}" 
            ${this.isAdmin ? `onclick="App.toggleStatus(${t.id})"` : 'style="cursor:default"'}>${t.status}</span></td>
        <td><span class="priority-badge priority-${t.priority.toLowerCase()}">${t.priority}</span></td>
        <td>${t.lastUpdated || 'N/A'}</td>
        <td>${this.isAdmin ? 
          `<button class="btn btn-primary" onclick="App.editTask(${t.id})" style="padding:8px 15px;min-height:auto;margin-right:5px"><i class="fas fa-edit"></i></button>
           <button class="btn btn-danger" onclick="App.deleteTask(${t.id})" style="padding:8px 15px;min-height:auto"><i class="fas fa-trash"></i></button>` 
          : '<span style="color:#6c757d">View Only</span>'}</td>
      </tr>
    `).join('');
    document.getElementById('taskTableBody').innerHTML = html;
  },

  getDaysBadge(d, s) {
    if (s === 'Completed') return '<span class="days-badge days-ok">Done</span>';
    if (!d || d === 'Daily' || d === 'Completed') return '<span class="days-badge days-ok">Ongoing</span>';
    
    const deadline = new Date(d);
    const today = new Date();
    const diff = Math.ceil((deadline - today) / (1000 * 60 * 60 * 24));
    
    if (diff < 0) return `<span class="days-badge days-overdue">${Math.abs(diff)}d overdue</span>`;
    if (diff <= 7) return `<span class="days-badge days-soon">${diff}d left</span>`;
    return `<span class="days-badge days-ok">${diff}d left</span>`;
  },

  isOverdue(d) {
    if (!d || d === 'Daily' || d === 'Completed') return false;
    return new Date(d) < new Date();
  },

  async toggleStatus(id) {
    if (!this.isAdmin) return;
    const task = this.tasks.find(t => t.id === id);
    if (!task) return;
    
    const states = ['Not Started', 'In Progress', 'Completed'];
    const idx = states.indexOf(task.status);
    task.status = states[(idx + 1) % states.length];
    task.lastUpdated = new Date().toISOString().split('T')[0];
    
    await this.saveTasksToCloud();
    this.renderDashboard();
    this.renderTaskTable();
  },

  async deleteTask(id) {
    if (!this.isAdmin || !confirm('Delete this task?')) return;
    this.tasks = this.tasks.filter(t => t.id !== id);
    await this.saveTasksToCloud();
    this.renderDashboard();
    this.renderTaskTable();
  },

  editTask(id) {
    if (!this.isAdmin) return;
    const task = this.tasks.find(t => t.id === id);
    if (!task) return;
    
    document.getElementById('modalTitle').textContent = 'Edit Task';
    document.getElementById('editTaskId').value = task.id;
    document.getElementById('taskDesc').value = task.description;
    document.getElementById('taskCategory').value = task.category;
    document.getElementById('taskResponsible').value = task.responsible;
    document.getElementById('taskDeadline').value = task.deadline;
    document.getElementById('taskStatus').value = task.status;
    document.getElementById('taskPriority').value = task.priority;
    document.getElementById('taskRemarks').value = task.remarks || '';
    document.getElementById('addTaskModal').classList.add('active');
  },

  openAddTaskModal() {
    if (!this.isAdmin) {
      alert('Admin login required');
      return;
    }
    
    document.getElementById('modalTitle').textContent = 'Add Task';
    document.getElementById('editTaskId').value = '';
    document.getElementById('taskDesc').value = '';
    document.getElementById('taskCategory').value = '';
    document.getElementById('taskResponsible').value = '';
    document.getElementById('taskDeadline').value = '';
    document.getElementById('taskStatus').value = 'Not Started';
    document.getElementById('taskPriority').value = 'Low';
    document.getElementById('taskRemarks').value = '';
    document.getElementById('addTaskModal').classList.add('active');
  },

  closeAddTaskModal() {
    document.getElementById('addTaskModal').classList.remove('active');
  },

  async saveTask() {
    if (!this.isAdmin) return;
    
    const editId = document.getElementById('editTaskId').value;
    const desc = document.getElementById('taskDesc').value;
    const cat = document.getElementById('taskCategory').value;
    const resp = document.getElementById('taskResponsible').value;
    const dead = document.getElementById('taskDeadline').value;
    const stat = document.getElementById('taskStatus').value;
    const pri = document.getElementById('taskPriority').value;
    const rem = document.getElementById('taskRemarks').value;
    
    if (!desc || !cat || !resp) {
      alert('Please fill required fields');
      return;
    }
    
    const now = new Date().toISOString().split('T')[0];
    
    if (editId) {
      const task = this.tasks.find(t => t.id === parseInt(editId));
      if (task) {
        task.description = desc;
        task.category = cat;
        task.responsible = resp;
        task.deadline = dead;
        task.status = stat;
        task.priority = pri;
        task.remarks = rem;
        task.lastUpdated = now;
        this.showSuccess('Task updated!');
      }
    } else {
      const maxId = this.tasks.length > 0 ? Math.max(...this.tasks.map(t => t.id)) : 0;
      this.tasks.push({
        id: maxId + 1,
        description: desc,
        category: cat,
        responsible: resp,
        deadline: dead,
        status: stat,
        priority: pri,
        remarks: rem,
        lastUpdated: now
      });
      this.showSuccess('Task added!');
    }
    
    await this.saveTasksToCloud();
    this.renderDashboard();
    this.renderTaskTable();
    this.closeAddTaskModal();
  },

  exportToCSV() {
    const csv = [
      'ID,Description,Category,Responsible,Deadline,Status,Priority,Remarks,Last Updated',
      ...this.tasks.map(t => `${t.id},"${t.description}","${t.category}","${t.responsible}",${t.deadline},${t.status},${t.priority},"${t.remarks || ''}",${t.lastUpdated || ''}`)
    ].join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'jct-tasks-' + new Date().toISOString().split('T')[0] + '.csv';
    a.click();
    this.showSuccess('Exported!');
  },

  async importFromCSV(e) {
    if (!this.isAdmin) {
      alert('Admin login required');
      return;
    }
    
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async (ev) => {
      try {
        const text = ev.target.result;
        const lines = text.split('\n');
        
        if (lines.length < 2) {
          alert('CSV file is empty');
          return;
        }
        
        const imported = [];
        const now = new Date().toISOString().split('T')[0];
        
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line || line.length < 5) continue;
          
          const cells = [];
          let current = '';
          let inQuotes = false;
          
          for (let j = 0; j < line.length; j++) {
            const char = line[j];
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              cells.push(current.trim().replace(/^"|"$/g, ''));
              current = '';
            } else {
              current += char;
            }
          }
          cells.push(current.trim().replace(/^"|"$/g, ''));
          
          if (cells.length >= 3) {
            imported.push({
              id: cells[0] ? parseInt(cells[0]) : i,
              description: cells[1] || 'No description',
              category: cells[2] || 'General',
              responsible: cells[3] || 'Unassigned',
              deadline: cells[4] || '',
              status: cells[5] || 'Not Started',
              priority: cells[6] || 'Medium',
              remarks: cells[7] || '',
              lastUpdated: cells[8] || now
            });
          }
        }
        
        if (imported.length > 0) {
          if (confirm(`Import ${imported.length} tasks? This will replace current data.`)) {
            this.tasks = imported;
            await this.saveTasksToCloud();
            this.renderDashboard();
            this.renderTaskTable();
            this.showSuccess(`Imported ${imported.length} tasks!`);
          }
        } else {
          alert('No valid tasks found in CSV');
        }
      } catch (error) {
        console.error('Import error:', error);
        alert('Failed to import CSV');
      } finally {
        e.target.value = '';
      }
    };
    reader.readAsText(file);
  },

  showSuccess(msg) {
    const sm = document.getElementById('successMessage');
    document.getElementById('successText').textContent = msg;
    sm.classList.add('show');
    setTimeout(() => sm.classList.remove('show'), 2000);
  },

  getSampleTasks() {
    const now = new Date().toISOString().split('T')[0];
    return [
      {id:1,description:"Entrance neat and clean",category:"Arts & Science",responsible:"Vinod/Manikam",deadline:"Daily",status:"In Progress",priority:"Medium",remarks:"",lastUpdated:now},
      {id:2,description:"XEROX Center needed",category:"Arts & Science",responsible:"Senthil supervisor",deadline:"2025-11-24",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
      {id:3,description:"Surveillance cameras",category:"Arts & Science",responsible:"vineeth",deadline:"2025-11-24",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
      {id:4,description:"Girls toilet incinerator",category:"Polytechnic",responsible:"Senthil/manager",deadline:"Completed",status:"Completed",priority:"Low",remarks:"",lastUpdated:now},
      {id:5,description:"All damaged chairs repair",category:"Engineering",responsible:"Senthil supervisor",deadline:"2025-11-06",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
      {id:6,description:"Floor repair work",category:"Engineering",responsible:"Senthil supervisor",deadline:"2025-11-30",status:"Not Started",priority:"High",remarks:"1000 Sq.ft tiles",lastUpdated:now},
      {id:7,description:"Smart board purchase",category:"Engineering",responsible:"Manager",deadline:"2025-11-30",status:"Not Started",priority:"High",remarks:"4 classrooms",lastUpdated:now},
      {id:8,description:"Rolling shutter service",category:"Engineering",responsible:"Senthil supervisor",deadline:"2025-11-16",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
      {id:9,description:"Wire purchase for centre",category:"Campus",responsible:"Senthil/Manager",deadline:"2025-11-14",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
      {id:10,description:"Ladies washroom ready",category:"Campus",responsible:"Senthil supervisor",deadline:"2025-12-30",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
      {id:11,description:"Heavy Duty Incinerator",category:"Girls Hostel",responsible:"Electrician/manager",deadline:"2025-11-08",status:"Not Started",priority:"High",remarks:"2 more needed",lastUpdated:now},
      {id:12,description:"Fan and tube purchase",category:"Girls Hostel",responsible:"Electrician/manager",deadline:"2025-11-04",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
      {id:13,description:"Camera installation",category:"Boys Hostel",responsible:"vineeth",deadline:"2025-11-08",status:"In Progress",priority:"High",remarks:"2nd & 3rd floor",lastUpdated:now},
      {id:14,description:"STP plant hostel B",category:"Boys Hostel",responsible:"Senthil/Manager",deadline:"",status:"In Progress",priority:"High",remarks:"3 months",lastUpdated:now},
      {id:15,description:"Cooking vessels",category:"Mess",responsible:"Jayaraj/Manager",deadline:"2025-11-08",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
      {id:16,description:"Industrial mixer",category:"Mess",responsible:"Jayaraj/Manager",deadline:"",status:"Not Started",priority:"Medium",remarks:"",lastUpdated:now},
      {id:17,description:"Steamers service",category:"Mess",responsible:"Jayaraj",deadline:"2025-11-03",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
      {id:18,description:"Tata Ace repair",category:"Transport",responsible:"Transport/Manager",deadline:"",status:"Not Started",priority:"Medium",remarks:"Exchange",lastUpdated:now},
      {id:19,description:"First aid kits",category:"Transport",responsible:"Transport Incharge",deadline:"",status:"Not Started",priority:"High",remarks:"All buses",lastUpdated:now},
      {id:20,description:"Three new buses",category:"Transport",responsible:"Transport/Manager",deadline:"2025-10-29",status:"In Progress",priority:"High",remarks:"",lastUpdated:now}
    ];
  }
};

// Initialize app
App.init();
</script>
</body>
</html>