<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="description" content="JCT Estate Task Manager - Simple, powerful task management system for estate operations">
<meta name="keywords" content="task manager, estate management, task tracking">
<meta name="author" content="JCT Estate">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>JCT Estate Task Manager</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
<link rel="preconnect" href="https://cdnjs.cloudflare.com">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:10px;color:#333}
.container{max-width:1400px;margin:0 auto;background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden}
.header{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);color:white;padding:20px;text-align:center}
.header h1{font-size:24px;margin-bottom:10px}
.header p{font-size:16px;opacity:0.9}
.header div{margin-top:15px;display:flex;flex-wrap:wrap;justify-content:center;align-items:center;gap:10px}
.tabs{display:flex;background:#f8f9fa;border-bottom:3px solid #dee2e6;flex-wrap:wrap}
.tab{flex:1;padding:15px;text-align:center;font-size:16px;font-weight:bold;cursor:pointer;border:none;background:#f8f9fa;color:#6c757d;transition:all 0.3s;min-height:60px;display:flex;align-items:center;justify-content:center;gap:8px;min-width:120px}
.tab:hover{background:#e9ecef}
.tab.active{background:white;color:#1e3c72;border-bottom:3px solid #1e3c72}
.tab i{font-size:20px}
.tab-content{display:none;padding:15px;animation:fadeIn 0.3s}
.tab-content.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
.stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:20px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.2);text-align:center}
.stat-card.completed{background:linear-gradient(135deg,#11998e 0%,#38ef7d 100%)}
.stat-card.progress{background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%)}
.stat-card.overdue{background:linear-gradient(135deg,#fa709a 0%,#fee140 100%)}
.stat-card i{font-size:36px;margin-bottom:10px}
.stat-number{font-size:36px;font-weight:bold;margin:8px 0}
.stat-label{font-size:16px;opacity:0.9}
.progress-section{background:#f8f9fa;padding:20px;border-radius:15px;margin-bottom:20px}
.progress-label{font-size:18px;font-weight:bold;margin-bottom:12px;color:#1e3c72}
.progress-bar-container{background:#dee2e6;height:35px;border-radius:18px;overflow:hidden;position:relative}
.progress-bar{height:100%;background:linear-gradient(90deg,#11998e 0%,#38ef7d 100%);transition:width 0.5s ease;display:flex;align-items:center;justify-content:center;color:white;font-weight:bold;font-size:16px}
.filters{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:20px}
.filter-btn{padding:12px 20px;border:none;border-radius:8px;background:#e9ecef;color:#495057;font-size:14px;font-weight:bold;cursor:pointer;transition:all 0.3s;min-height:45px;white-space:nowrap}
.filter-btn:hover{background:#dee2e6;transform:translateY(-2px)}
.filter-btn.active{background:#1e3c72;color:white}
.urgent-section{background:#fff3cd;border-left:5px solid #ffc107;padding:20px;border-radius:10px;margin-bottom:20px}
.urgent-section h3{color:#856404;margin-bottom:15px;font-size:20px}
.urgent-task{background:white;padding:15px;border-radius:10px;margin-bottom:12px;border-left:5px solid #dc3545}
.table-container{overflow-x:auto;background:#f8f9fa;border-radius:15px;padding:15px;-webkit-overflow-scrolling:touch}
table{width:100%;border-collapse:collapse;background:white;border-radius:10px;overflow:hidden;min-width:800px}
th{background:#1e3c72;color:white;padding:12px 8px;text-align:left;font-size:14px;font-weight:bold;white-space:nowrap}
td{padding:10px 8px;border-bottom:1px solid #dee2e6;font-size:14px}
tr:hover{background:#f8f9fa}
.status-badge{padding:6px 12px;border-radius:15px;font-weight:bold;display:inline-block;font-size:12px;cursor:pointer;transition:all 0.3s;min-width:100px;text-align:center}
.status-badge:hover{transform:scale(1.05)}
.status-completed{background:#d4edda;color:#155724}
.status-progress{background:#fff3cd;color:#856404}
.status-notstarted{background:#f8d7da;color:#721c24}
.priority-badge{padding:5px 10px;border-radius:12px;font-weight:bold;display:inline-block;font-size:12px}
.priority-high{background:#dc3545;color:white}
.priority-medium{background:#ffc107;color:#333}
.priority-low{background:#28a745;color:white}
.btn{padding:12px 20px;border:none;border-radius:8px;font-size:14px;font-weight:bold;cursor:pointer;transition:all 0.3s;min-height:45px;display:inline-flex;align-items:center;justify-content:center;gap:8px;white-space:nowrap}
.btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}
.btn:focus{outline:2px solid #1e3c72;outline-offset:2px}
.btn-primary{background:#1e3c72;color:white}
.btn-success{background:#28a745;color:white}
.btn-danger{background:#dc3545;color:white}
.btn-secondary{background:#6c757d;color:white}
.action-btns{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px}
.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);overflow-y:auto;padding:20px 10px}
.modal.active{display:flex;align-items:flex-start;justify-content:center;padding-top:20px}
.modal-content{background:white;padding:25px;border-radius:15px;max-width:600px;width:100%;margin:20px auto;max-height:90vh;overflow-y:auto;position:relative}
.modal h2{margin-bottom:20px;color:#1e3c72;font-size:24px}
.form-group{margin-bottom:20px}
.form-group label{display:block;margin-bottom:8px;font-weight:bold;font-size:16px;color:#495057}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:2px solid #dee2e6;border-radius:8px;font-size:16px;-webkit-appearance:none;appearance:none}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#1e3c72}
.form-group textarea{min-height:80px;resize:vertical}
.days-badge{padding:4px 8px;border-radius:8px;font-weight:bold;font-size:12px;display:inline-block}
.days-overdue{background:#dc3545;color:white}
.days-soon{background:#ffc107;color:#333}
.days-ok{background:#28a745;color:white}
.success-message{background:#d4edda;color:#155724;padding:12px 15px;border-radius:8px;margin:15px 20px;display:none;border-left:5px solid #28a745}
.success-message.show{display:block}
.error-message{background:#f8d7da;color:#721c24;padding:12px 15px;border-radius:8px;margin:15px 20px;display:none;border-left:5px solid #dc3545}
.error-message.show{display:block}
.warning-message{background:#fff3cd;color:#856404;padding:12px 15px;border-radius:8px;margin:15px 20px;display:none;border-left:5px solid #ffc107}
.warning-message.show{display:block}
@media(max-width:768px){
.header h1{font-size:20px}
.header p{font-size:14px}
.tabs{flex-direction:row}
.tab{flex:1;min-width:auto;padding:12px 8px;font-size:14px}
.tab i{font-size:16px}
.stats-grid{grid-template-columns:repeat(2,1fr);gap:10px}
.stat-card{padding:15px}
.stat-card i{font-size:28px}
.stat-number{font-size:28px}
.stat-label{font-size:14px}
.filter-btn{padding:10px 15px;font-size:12px;min-height:40px}
.action-btns{flex-direction:column}
.action-btns .btn{width:100%;justify-content:center}
.table-container{padding:10px}
table{min-width:1000px}
th,td{padding:8px 6px;font-size:12px}
.modal-content{padding:20px;margin:10px}
.modal h2{font-size:20px}
.form-group{margin-bottom:15px}
.form-group label{font-size:14px}
.form-group input,.form-group select,.form-group textarea{font-size:14px;padding:10px}
}
@media(max-width:480px){
body{padding:5px}
.container{border-radius:10px}
.header{padding:15px}
.header h1{font-size:18px}
.stats-grid{grid-template-columns:1fr}
.tab{padding:10px 5px;font-size:12px}
.filter-btn{font-size:11px;padding:8px 12px}
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<h1><i class="fas fa-tasks"></i> JCT Estate Task Manager</h1>
<p>Simple. Powerful. Always Working.</p>
<div>
<span id="loginStatus" style="font-size:14px"><i class="fas fa-eye"></i> View Mode</span>
<button class="btn btn-secondary" onclick="showLoginModal()" style="padding:8px 15px;min-height:auto;font-size:12px" aria-label="Admin Login"><i class="fas fa-key"></i> Admin Login</button>
<button class="btn btn-danger" onclick="logout()" id="logoutBtn" style="padding:8px 15px;min-height:auto;font-size:12px;display:none" aria-label="Logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
</div>
</div>
<div class="success-message" id="successMessage">
<i class="fas fa-check-circle"></i> <span id="successText">Saved!</span>
</div>
<div class="error-message" id="errorMessage">
<i class="fas fa-exclamation-circle"></i> <span id="errorText">Error occurred!</span>
</div>
<div class="warning-message" id="warningMessage">
<i class="fas fa-exclamation-triangle"></i> <span id="warningText">Warning!</span>
</div>
<div class="tabs">
<button class="tab active" onclick="switchTab('dashboard')" aria-label="Dashboard Tab"><i class="fas fa-chart-line"></i> Dashboard</button>
<button class="tab" onclick="switchTab('tasks')" aria-label="Tasks Tab"><i class="fas fa-list-check"></i> Tasks</button>
</div>
<div class="tab-content active" id="dashboard">
<div class="stats-grid">
<div class="stat-card"><i class="fas fa-clipboard-list"></i><div class="stat-number" id="totalTasks">0</div><div class="stat-label">Total Tasks</div></div>
<div class="stat-card completed"><i class="fas fa-check-circle"></i><div class="stat-number" id="completedTasks">0</div><div class="stat-label">Completed</div></div>
<div class="stat-card progress"><i class="fas fa-spinner"></i><div class="stat-number" id="progressTasks">0</div><div class="stat-label">In Progress</div></div>
<div class="stat-card overdue"><i class="fas fa-exclamation-triangle"></i><div class="stat-number" id="overdueTasks">0</div><div class="stat-label">Overdue</div></div>
</div>
<div class="progress-section">
<div class="progress-label">Overall Completion Progress</div>
<div class="progress-bar-container"><div class="progress-bar" id="progressBar">0%</div></div>
</div>
<div class="filters">
<button class="filter-btn active" onclick="filterByCategory('all')"><i class="fas fa-th"></i> All</button>
<button class="filter-btn" onclick="filterByCategory('Arts & Science')"><i class="fas fa-university"></i> Arts & Science</button>
<button class="filter-btn" onclick="filterByCategory('Polytechnic')"><i class="fas fa-cog"></i> Polytechnic</button>
<button class="filter-btn" onclick="filterByCategory('Engineering')"><i class="fas fa-wrench"></i> Engineering</button>
<button class="filter-btn" onclick="filterByCategory('Campus')"><i class="fas fa-building"></i> Campus</button>
<button class="filter-btn" onclick="filterByCategory('Girls Hostel')"><i class="fas fa-female"></i> Girls Hostel</button>
<button class="filter-btn" onclick="filterByCategory('Boys Hostel')"><i class="fas fa-male"></i> Boys Hostel</button>
<button class="filter-btn" onclick="filterByCategory('Mess')"><i class="fas fa-utensils"></i> Mess</button>
<button class="filter-btn" onclick="filterByCategory('Transport')"><i class="fas fa-bus"></i> Transport</button>
</div>
<div class="urgent-section">
<h3><i class="fas fa-bell"></i> Urgent Tasks</h3>
<div id="urgentTasksList"></div>
</div>
</div>
<div class="tab-content" id="tasks">
<div class="action-btns">
<button class="btn btn-primary" onclick="openAddTaskModal()"><i class="fas fa-plus"></i> Add Task</button>
<button class="btn btn-success" onclick="exportToCSV()"><i class="fas fa-download"></i> Export</button>
<button class="btn btn-secondary" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> Import CSV</button>
<input type="file" id="importFile" accept=".csv" style="display:none" onchange="importFromCSV(event)">
</div>
<div class="table-container">
<table><thead><tr><th>ID</th><th>Description</th><th>Category</th><th>Responsible</th><th>Deadline</th><th>Days</th><th>Status</th><th>Priority</th><th>Last Updated</th><th>Actions</th></tr></thead>
<tbody id="taskTableBody"></tbody></table>
</div>
</div>
</div>
<div class="modal" id="addTaskModal">
<div class="modal-content">
<h2><i class="fas fa-plus-circle"></i> <span id="modalTitle">Add Task</span></h2>
<input type="hidden" id="editTaskId">
<div class="form-group"><label>Description *</label><textarea id="taskDesc" required></textarea></div>
<div class="form-group"><label>Category *</label><select id="taskCategory" required><option value="">Select</option><option>Arts & Science</option><option>Polytechnic</option><option>Engineering</option><option>Campus</option><option>Girls Hostel</option><option>Boys Hostel</option><option>Mess</option><option>Transport</option></select></div>
<div class="form-group"><label>Responsible *</label><input type="text" id="taskResponsible" required></div>
<div class="form-group"><label>Deadline</label><input type="date" id="taskDeadline"></div>
<div class="form-group"><label>Status *</label><select id="taskStatus" required><option>Not Started</option><option>In Progress</option><option>Completed</option></select></div>
<div class="form-group"><label>Priority *</label><select id="taskPriority" required><option>Low</option><option>Medium</option><option>High</option></select></div>
<div class="form-group"><label>Remarks</label><textarea id="taskRemarks"></textarea></div>
<div class="action-btns">
<button class="btn btn-primary" onclick="saveTask()"><i class="fas fa-save"></i> Save</button>
<button class="btn btn-secondary" onclick="closeAddTaskModal()"><i class="fas fa-times"></i> Cancel</button>
</div>
</div>
</div>
<div class="modal" id="loginModal">
<div class="modal-content">
<h2><i class="fas fa-lock"></i> Admin Login</h2>
<div class="form-group"><label>Password</label><input type="password" id="adminPassword" placeholder="Enter admin password" autocomplete="current-password"></div>
<div class="action-btns">
<button class="btn btn-primary" onclick="login()"><i class="fas fa-sign-in-alt"></i> Login</button>
<button class="btn btn-secondary" onclick="closeLoginModal()"><i class="fas fa-times"></i> Cancel</button>
</div>
</div>
</div>
<script>
'use strict';
let tasks=[];
let currentFilter='all';
let isAdmin=false;
const ADMIN_PASSWORD='jct2025';
let storageAvailable=true;
let memoryStorage={};

// Storage utility with fallback
function isStorageAvailable(type){
    try{
        const storage=window[type];
        const x='__storage_test__';
        storage.setItem(x,x);
        storage.removeItem(x);
        return true;
    }catch(e){
        return false;
    }
}

function getStorageItem(key){
    if(!storageAvailable)return memoryStorage[key]||null;
    try{
        return localStorage.getItem(key);
    }catch(e){
        console.warn('localStorage access failed:',e);
        storageAvailable=false;
        return memoryStorage[key]||null;
    }
}

function setStorageItem(key,value){
    if(!storageAvailable){
        memoryStorage[key]=value;
        showWarning('Storage unavailable. Data saved in memory only (will be lost on page refresh).');
        return;
    }
    try{
        localStorage.setItem(key,value);
    }catch(e){
        if(e.name==='QuotaExceededError'){
            showError('Storage quota exceeded. Please export your data and clear some space.');
            storageAvailable=false;
            memoryStorage[key]=value;
        }else{
            console.warn('localStorage setItem failed:',e);
            storageAvailable=false;
            memoryStorage[key]=value;
            showWarning('Storage unavailable. Data saved in memory only.');
        }
    }
}

function getSessionStorageItem(key){
    try{
        return sessionStorage.getItem(key);
    }catch(e){
        console.warn('sessionStorage access failed:',e);
        return memoryStorage['session_'+key]||null;
    }
}

function setSessionStorageItem(key,value){
    try{
        sessionStorage.setItem(key,value);
    }catch(e){
        console.warn('sessionStorage setItem failed:',e);
        memoryStorage['session_'+key]=value;
    }
}

function removeSessionStorageItem(key){
    try{
        sessionStorage.removeItem(key);
    }catch(e){
        console.warn('sessionStorage removeItem failed:',e);
        delete memoryStorage['session_'+key];
    }
}

function showError(msg){
    const em=document.getElementById('errorMessage');
    document.getElementById('errorText').textContent=msg;
    em.classList.add('show');
    setTimeout(()=>em.classList.remove('show'),5000);
}

function showWarning(msg){
    const wm=document.getElementById('warningMessage');
    document.getElementById('warningText').textContent=msg;
    wm.classList.add('show');
    setTimeout(()=>wm.classList.remove('show'),5000);
}

function loadTasks(){
    storageAvailable=isStorageAvailable('localStorage');
    const saved=getStorageItem('jctTasks');
    if(saved){
        try{
            tasks=JSON.parse(saved);
            if(!Array.isArray(tasks)||tasks.length===0){
                tasks=getSampleTasks();
                saveTasks();
            }
        }catch(e){
            console.error('Error loading tasks:',e);
            showError('Error loading tasks. Using default data.');
            tasks=getSampleTasks();
            saveTasks();
        }
    }else{
        tasks=getSampleTasks();
        saveTasks();
    }
    checkAdminStatus();
    renderDashboard();
    renderTaskTable();
}

function checkAdminStatus(){
    const saved=getSessionStorageItem('jctAdminLoggedIn');
    isAdmin=saved==='true';
    updateUIForRole();
}

function updateUIForRole(){
    const status=document.getElementById('loginStatus');
    const logoutBtn=document.getElementById('logoutBtn');
    const actionBtns=document.querySelector('.action-btns');
    if(isAdmin){
        status.innerHTML='<i class="fas fa-user-shield"></i> Admin Mode';
        status.style.color='#28a745';
        logoutBtn.style.display='inline-flex';
        if(actionBtns)actionBtns.style.display='flex';
    }else{
        status.innerHTML='<i class="fas fa-eye"></i> View Mode';
        status.style.color='#ffc107';
        logoutBtn.style.display='none';
        if(actionBtns)actionBtns.style.display='none';
    }
}

function showLoginModal(){
    document.getElementById('loginModal').classList.add('active');
    document.getElementById('adminPassword').value='';
    document.getElementById('adminPassword').focus();
}

function closeLoginModal(){
    document.getElementById('loginModal').classList.remove('active');
}

function login(){
    const pwd=document.getElementById('adminPassword').value;
    if(pwd===ADMIN_PASSWORD){
        isAdmin=true;
        setSessionStorageItem('jctAdminLoggedIn','true');
        updateUIForRole();
        closeLoginModal();
        showSuccess('Logged in as Admin!');
        renderTaskTable();
    }else{
        showError('Invalid password!');
        document.getElementById('adminPassword').value='';
        document.getElementById('adminPassword').focus();
    }
}

function logout(){
    isAdmin=false;
    removeSessionStorageItem('jctAdminLoggedIn');
    updateUIForRole();
    showSuccess('Logged out');
    renderTaskTable();
}

function saveTasks(){
    try{
        setStorageItem('jctTasks',JSON.stringify(tasks));
        if(storageAvailable){
            showSuccess('Saved');
        }
    }catch(e){
        console.error('Error saving tasks:',e);
        showError('Failed to save tasks. Please export your data.');
    }
}

function getSampleTasks(){
    const now=new Date().toISOString().split('T')[0];
    return[
        {id:1,description:"Entrance neat and clean",category:"Arts & Science",responsible:"Vinod/Manikam",deadline:"Daily",status:"In Progress",priority:"Medium",remarks:"",lastUpdated:now},
        {id:2,description:"XEROX Center needed",category:"Arts & Science",responsible:"Senthil supervisor",deadline:"2025-11-24",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
        {id:3,description:"Surveillance cameras",category:"Arts & Science",responsible:"vineeth",deadline:"2025-11-24",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
        {id:4,description:"Girls toilet incinerator",category:"Polytechnic",responsible:"Senthil/manager",deadline:"Completed",status:"Completed",priority:"Low",remarks:"",lastUpdated:now},
        {id:5,description:"All damaged chairs repair",category:"Engineering",responsible:"Senthil supervisor",deadline:"2025-11-06",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
        {id:6,description:"Floor repair work",category:"Engineering",responsible:"Senthil supervisor",deadline:"2025-11-30",status:"Not Started",priority:"High",remarks:"1000 Sq.ft tiles",lastUpdated:now},
        {id:7,description:"Smart board purchase",category:"Engineering",responsible:"Manager",deadline:"2025-11-30",status:"Not Started",priority:"High",remarks:"4 classrooms",lastUpdated:now},
        {id:8,description:"Rolling shutter service",category:"Engineering",responsible:"Senthil supervisor",deadline:"2025-11-16",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
        {id:9,description:"Wire purchase for centre",category:"Campus",responsible:"Senthil/Manager",deadline:"2025-11-14",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
        {id:10,description:"Ladies washroom ready",category:"Campus",responsible:"Senthil supervisor",deadline:"2025-12-30",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
        {id:11,description:"Heavy Duty Incinerator",category:"Girls Hostel",responsible:"Electrician/manager",deadline:"2025-11-08",status:"Not Started",priority:"High",remarks:"2 more needed",lastUpdated:now},
        {id:12,description:"Fan and tube purchase",category:"Girls Hostel",responsible:"Electrician/manager",deadline:"2025-11-04",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
        {id:13,description:"Camera installation",category:"Boys Hostel",responsible:"vineeth",deadline:"2025-11-08",status:"In Progress",priority:"High",remarks:"2nd & 3rd floor",lastUpdated:now},
        {id:14,description:"STP plant hostel B",category:"Boys Hostel",responsible:"Senthil/Manager",deadline:"",status:"In Progress",priority:"High",remarks:"3 months",lastUpdated:now},
        {id:15,description:"Cooking vessels",category:"Mess",responsible:"Jayaraj/Manager",deadline:"2025-11-08",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
        {id:16,description:"Industrial mixer",category:"Mess",responsible:"Jayaraj/Manager",deadline:"",status:"Not Started",priority:"Medium",remarks:"",lastUpdated:now},
        {id:17,description:"Steamers service",category:"Mess",responsible:"Jayaraj",deadline:"2025-11-03",status:"Not Started",priority:"High",remarks:"",lastUpdated:now},
        {id:18,description:"Tata Ace repair",category:"Transport",responsible:"Transport/Manager",deadline:"",status:"Not Started",priority:"Medium",remarks:"Exchange",lastUpdated:now},
        {id:19,description:"First aid kits",category:"Transport",responsible:"Transport Incharge",deadline:"",status:"Not Started",priority:"High",remarks:"All buses",lastUpdated:now},
        {id:20,description:"Three new buses",category:"Transport",responsible:"Transport/Manager",deadline:"2025-10-29",status:"In Progress",priority:"High",remarks:"",lastUpdated:now}
    ];
}

function switchTab(t){
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    event.target.closest('.tab').classList.add('active');
    document.getElementById(t).classList.add('active');
}

function filterByCategory(c){
    currentFilter=c;
    document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));
    event.target.classList.add('active');
    renderDashboard();
}

function renderDashboard(){
    const f=currentFilter==='all'?tasks:tasks.filter(t=>t.category===currentFilter);
    const total=f.length;
    const completed=f.filter(t=>t.status==='Completed').length;
    const progress=f.filter(t=>t.status==='In Progress').length;
    const overdue=f.filter(t=>isOverdue(t.deadline)&&t.status!=='Completed').length;
    document.getElementById('totalTasks').textContent=total;
    document.getElementById('completedTasks').textContent=completed;
    document.getElementById('progressTasks').textContent=progress;
    document.getElementById('overdueTasks').textContent=overdue;
    const pct=total>0?Math.round((completed/total)*100):0;
    document.getElementById('progressBar').style.width=pct+'%';
    document.getElementById('progressBar').textContent=pct+'%';
    const urgent=f.filter(t=>t.priority==='High'&&t.status!=='Completed');
    const ul=document.getElementById('urgentTasksList');
    ul.innerHTML=urgent.length===0?'<div class="urgent-task">No urgent tasks! Great job!</div>':urgent.map(t=>`<div class="urgent-task"><strong>${t.description}</strong><br><small>${t.category} - ${t.responsible} - Due: ${t.deadline}</small></div>`).join('');
}

function renderTaskTable(){
    const tb=document.getElementById('taskTableBody');
    tb.innerHTML=tasks.map(t=>`<tr><td>${t.id}</td><td>${t.description}</td><td>${t.category}</td><td>${t.responsible}</td><td>${t.deadline}</td><td>${getDaysBadge(t.deadline,t.status)}</td><td><span class="status-badge status-${t.status.toLowerCase().replace(' ','')}" ${isAdmin?`onclick="toggleStatus(${t.id})"`:'style="cursor:default"'}>${t.status}</span></td><td><span class="priority-badge priority-${t.priority.toLowerCase()}">${t.priority}</span></td><td>${t.lastUpdated||'N/A'}</td><td>${isAdmin?`<button class="btn btn-primary" onclick="editTask(${t.id})" style="padding:6px 12px;min-height:auto;margin-right:5px;font-size:12px" aria-label="Edit Task ${t.id}"><i class="fas fa-edit"></i></button><button class="btn btn-danger" onclick="deleteTask(${t.id})" style="padding:6px 12px;min-height:auto;font-size:12px" aria-label="Delete Task ${t.id}"><i class="fas fa-trash"></i></button>`:'<span style="color:#6c757d;font-size:12px">View Only</span>'}</td></tr>`).join('');
}

function getDaysBadge(d,s){
    if(s==='Completed')return'<span class="days-badge days-ok">Done</span>';
    if(d==='Daily'||d==='Daily routine'||d==='Regular work'||d==='Completed'||!d||d==='')return'<span class="days-badge days-ok">Ongoing</span>';
    const dd=new Date(d);
    const today=new Date();
    const diff=Math.ceil((dd-today)/(1000*60*60*24));
    if(diff<0)return`<span class="days-badge days-overdue">${Math.abs(diff)}d overdue</span>`;
    if(diff<=7)return`<span class="days-badge days-soon">${diff}d left</span>`;
    return`<span class="days-badge days-ok">${diff}d left</span>`;
}

function isOverdue(d){
    if(d==='Daily'||d==='Daily routine'||d==='Regular work'||d==='Completed'||!d||d==='')return false;
    const dd=new Date(d);
    const today=new Date();
    return dd<today;
}

function toggleStatus(id){
    if(!isAdmin)return;
    const t=tasks.find(x=>x.id===id);
    if(!t)return;
    const states=['Not Started','In Progress','Completed'];
    const i=states.indexOf(t.status);
    t.status=states[(i+1)%states.length];
    t.lastUpdated=new Date().toISOString().split('T')[0];
    saveTasks();
    renderDashboard();
    renderTaskTable();
}

function deleteTask(id){
    if(!isAdmin)return;
    if(confirm('Delete this task?')){
        tasks=tasks.filter(t=>t.id!==id);
        saveTasks();
        renderDashboard();
        renderTaskTable();
    }
}

function editTask(id){
    if(!isAdmin)return;
    const t=tasks.find(x=>x.id===id);
    if(!t)return;
    document.getElementById('modalTitle').textContent='Edit Task';
    document.getElementById('editTaskId').value=t.id;
    document.getElementById('taskDesc').value=t.description;
    document.getElementById('taskCategory').value=t.category;
    document.getElementById('taskResponsible').value=t.responsible;
    document.getElementById('taskDeadline').value=t.deadline;
    document.getElementById('taskStatus').value=t.status;
    document.getElementById('taskPriority').value=t.priority;
    document.getElementById('taskRemarks').value=t.remarks||'';
    document.getElementById('addTaskModal').classList.add('active');
    document.getElementById('taskDesc').focus();
}

function openAddTaskModal(){
    if(!isAdmin){
        showError('Admin login required to add tasks');
        return;
    }
    document.getElementById('modalTitle').textContent='Add Task';
    document.getElementById('editTaskId').value='';
    document.getElementById('taskDesc').value='';
    document.getElementById('taskCategory').value='';
    document.getElementById('taskResponsible').value='';
    document.getElementById('taskDeadline').value='';
    document.getElementById('taskStatus').value='Not Started';
    document.getElementById('taskPriority').value='Low';
    document.getElementById('taskRemarks').value='';
    document.getElementById('addTaskModal').classList.add('active');
    document.getElementById('taskDesc').focus();
}

function closeAddTaskModal(){
    document.getElementById('addTaskModal').classList.remove('active');
}

function saveTask(){
    if(!isAdmin)return;
    const editId=document.getElementById('editTaskId').value;
    const desc=document.getElementById('taskDesc').value.trim();
    const cat=document.getElementById('taskCategory').value;
    const resp=document.getElementById('taskResponsible').value.trim();
    const dead=document.getElementById('taskDeadline').value;
    const stat=document.getElementById('taskStatus').value;
    const pri=document.getElementById('taskPriority').value;
    const rem=document.getElementById('taskRemarks').value.trim();
    if(!desc||!cat||!resp){
        showError('Please fill all required fields');
        return;
    }
    const now=new Date().toISOString().split('T')[0];
    if(editId){
        const t=tasks.find(x=>x.id===parseInt(editId));
        if(t){
            t.description=desc;
            t.category=cat;
            t.responsible=resp;
            t.deadline=dead;
            t.status=stat;
            t.priority=pri;
            t.remarks=rem;
            t.lastUpdated=now;
            showSuccess('Task updated!');
        }
    }else{
        const maxId=tasks.length>0?Math.max(...tasks.map(t=>t.id)):0;
        tasks.push({id:maxId+1,description:desc,category:cat,responsible:resp,deadline:dead,status:stat,priority:pri,remarks:rem,lastUpdated:now});
        showSuccess('Task added!');
    }
    saveTasks();
    renderDashboard();
    renderTaskTable();
    closeAddTaskModal();
}

function exportToCSV(){
    try{
        const csv=['ID,Description,Category,Responsible,Deadline,Status,Priority,Remarks,Last Updated',...tasks.map(t=>`${t.id},"${(t.description||'').replace(/"/g,'""')}","${(t.category||'').replace(/"/g,'""')}","${(t.responsible||'').replace(/"/g,'""')}",${t.deadline||''},${t.status||''},${t.priority||''},"${(t.remarks||'').replace(/"/g,'""')}",${t.lastUpdated||''}`)].join('\n');
        const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download='jct-tasks-'+new Date().toISOString().split('T')[0]+'.csv';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showSuccess('Exported!');
    }catch(e){
        console.error('Export error:',e);
        showError('Failed to export CSV. Please try again.');
    }
}

function parseCSVLine(line){
    const result=[];
    let current='';
    let inQuotes=false;
    for(let i=0;i<line.length;i++){
        const char=line[i];
        const nextChar=line[i+1];
        if(char==='"'){
            if(inQuotes&&nextChar==='"'){
                current+='"';
                i++;
            }else{
                inQuotes=!inQuotes;
            }
        }else if(char===','&&!inQuotes){
            result.push(current.trim());
            current='';
        }else{
            current+=char;
        }
    }
    result.push(current.trim());
    return result;
}

function importFromCSV(e){
    if(!isAdmin){
        showError('Admin login required to import');
        return;
    }
    const file=e.target.files[0];
    if(!file){
        return;
    }
    if(file.size>10*1024*1024){
        showError('File too large. Maximum size is 10MB.');
        e.target.value='';
        return;
    }
    const reader=new FileReader();
    reader.onload=function(ev){
        try{
            const text=ev.target.result;
            const lines=text.split(/\r?\n/).filter(line=>line.trim().length>0);
            if(lines.length<2){
                showError('CSV file is empty or invalid. Please ensure the file has a header row and at least one data row.');
                e.target.value='';
                return;
            }
            const imported=[];
            const now=new Date().toISOString().split('T')[0];
            for(let i=1;i<lines.length;i++){
                const line=lines[i].trim();
                if(!line)continue;
                try{
                    const cells=parseCSVLine(line);
                    if(cells.length>=3){
                        const task={
                            id:cells[0]?parseInt(cells[0])||(imported.length+1):(imported.length+1),
                            description:cells[1]||'No description',
                            category:cells[2]||'General',
                            responsible:cells[3]||'Unassigned',
                            deadline:cells[4]||'',
                            status:cells[5]||'Not Started',
                            priority:cells[6]||'Medium',
                            remarks:cells[7]||'',
                            lastUpdated:cells[8]||now
                        };
                        imported.push(task);
                    }
                }catch(err){
                    console.warn('Error parsing line '+i+':',err,line);
                }
            }
            if(imported.length>0){
                if(confirm(`Import ${imported.length} tasks? This will replace current data.`)){
                    tasks=imported;
                    saveTasks();
                    renderDashboard();
                    renderTaskTable();
                    showSuccess(`Imported ${imported.length} tasks!`);
                }
            }else{
                showError('No valid tasks found in CSV file. Please check the file format.\n\nExpected format:\nID,Description,Category,Responsible,Deadline,Status,Priority,Remarks,Last Updated');
            }
        }catch(error){
            console.error('Import error:',error);
            showError('Failed to import CSV: '+error.message);
        }finally{
            e.target.value='';
        }
    };
    reader.onerror=function(){
        showError('Error reading file. Please try again.');
        e.target.value='';
    };
    reader.readAsText(file,'UTF-8');
}

function showSuccess(msg){
    const sm=document.getElementById('successMessage');
    document.getElementById('successText').textContent=msg;
    sm.classList.add('show');
    setTimeout(()=>sm.classList.remove('show'),3000);
}

// Keyboard shortcuts and accessibility
document.addEventListener('keydown',function(e){
    if(e.key==='Escape'){
        const modals=document.querySelectorAll('.modal.active');
        if(modals.length>0){
            modals.forEach(modal=>{
                if(modal.id==='addTaskModal')closeAddTaskModal();
                if(modal.id==='loginModal')closeLoginModal();
            });
        }
    }
    if(e.key==='Enter'&&e.ctrlKey){
        const activeModal=document.querySelector('.modal.active');
        if(activeModal&&activeModal.id==='addTaskModal'&&isAdmin){
            saveTask();
        }else if(activeModal&&activeModal.id==='loginModal'){
            login();
        }
    }
});

// Close modal when clicking outside
document.addEventListener('click',function(e){
    if(e.target.classList.contains('modal')){
        if(e.target.id==='addTaskModal')closeAddTaskModal();
        if(e.target.id==='loginModal')closeLoginModal();
    }
});

// Initialize on page load
if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded',loadTasks);
}else{
    loadTasks();
}

// Handle online/offline status
window.addEventListener('online',function(){
    showSuccess('Connection restored');
});

window.addEventListener('offline',function(){
    showWarning('No internet connection. App works offline but icons may not load.');
});
</script>
</body>
</html>
